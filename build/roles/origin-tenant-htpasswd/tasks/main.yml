---
- name: Checking httpd-tools are installed
  yum:
    name: httpd-tools

- name: Adding namespaces to the tenant
  command: "{{ oc }} new-project {{ tenant.name }}-{{ item.tag }} --description=\"{{ item.description }}\" --config={{ cfg }}"
  with_items: "{{ tenant.projects }}"

- name: Copying new-user script
  copy:
    src: "new-user.sh"
    dest: "{{ oc_path }}/new-user.sh"
    mode: "u+rw,g-wx,o-rwx"

- name: Adding users
  command: "sh {{ oc_path }}/new-user.sh {{ pwd_len }} {{ oc_path }} {{ item[0].name }}"
  with_items:
    - "{{ users }}"

- name: Adding users to roles in namespaces
  command: "sh {{ oc_path }}/add-role-to-user.sh {{ oc_path }} {{ item[0].name }} {{ tenant.name }}-{{ item[1].tag }} {{ item[0].isadmin }}"
  with_nested:
    - "{{ users }}"
    - "{{ tenant.projects }}"

- name: Copying resource quotas template
  copy:
    src: "{{ namespace_size }}-rsx-quota.yml"
    dest: "{{ oc_path }}/{{ namespace_size }}-rsx-quota.yml"

- name: Applying resource quotas
  command: "{{ oc }} create -f {{ oc_path }}/{{ namespace_size }}-rsx-quota.yml -n {{ tenant.name }}-{{ item }} --config={{ cfg }}"
  with_items: "{{ tenant.projects }}"
